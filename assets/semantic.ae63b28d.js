var qt=Object.defineProperty;var Ct=(o,n,e)=>n in o?qt(o,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[n]=e;var st=(o,n,e)=>(Ct(o,typeof n!="symbol"?n+"":n,e),e),$t=(o,n,e)=>{if(!n.has(o))throw TypeError("Cannot "+e)};var ot=(o,n,e)=>{if(n.has(o))throw TypeError("Cannot add the same private member more than once");n instanceof WeakSet?n.add(o):n.set(o,e)};var K=(o,n,e)=>($t(o,n,"access private method"),e);import"./modulepreload-polyfill.b7f2da20.js";import{f as Dt,g as Ft,a as zt,t as Vt,b as Pt,e as Bt}from"./sheets-api.2d2ad60f.js";import{env as Lt,pipeline as Ot}from"https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0";class Ut{constructor(n="EmbeddingsDB",e=1){this.dbName=n,this.version=e,this.db=null}async init(){return new Promise((n,e)=>{const t=indexedDB.open(this.dbName,this.version);t.onerror=()=>e(t.error),t.onsuccess=()=>{this.db=t.result,n(this.db)},t.onupgradeneeded=s=>{const r=s.target.result;r.objectStoreNames.contains("embeddings")||r.createObjectStore("embeddings",{keyPath:"text"}).createIndex("textHash","textHash",{unique:!1})}})}hashText(n){let e=0;for(let t=0;t<n.length;t++){const s=n.charCodeAt(t);e=(e<<5)-e+s,e=e&e}return e.toString()}async hasEmbeddings(n){const t=this.db.transaction(["embeddings"],"readonly").objectStore("embeddings");return new Promise((s,r)=>{const i=t.get(n);i.onsuccess=()=>s(!!i.result),i.onerror=()=>r(i.error)})}async getEmbeddings(n){const t=this.db.transaction(["embeddings"],"readonly").objectStore("embeddings");return new Promise((s,r)=>{const i=t.get(n);i.onsuccess=()=>{const l=i.result;s(l?l.embeddings:null)},i.onerror=()=>r(i.error)})}async storeEmbeddings(n,e){const s=this.db.transaction(["embeddings"],"readwrite").objectStore("embeddings"),r={text:n,embeddings:e,textHash:this.hashText(n),timestamp:Date.now()};return new Promise((i,l)=>{const h=s.put(r);h.onsuccess=()=>i(h.result),h.onerror=()=>l(h.error)})}async getOrCreateEmbeddings(n,e){try{const t=await this.getEmbeddings(n);if(t)return console.log("Using cached embeddings for:",n.substring(0,50)+"..."),t;console.log("Generating new embeddings for:",n.substring(0,50)+"...");const s=await e(n);return await this.storeEmbeddings(n,s),s}catch(t){throw console.error("Error in getOrCreateEmbeddings:",t),t}}async clearCache(){const e=this.db.transaction(["embeddings"],"readwrite").objectStore("embeddings");return new Promise((t,s)=>{const r=e.clear();r.onsuccess=()=>t(),r.onerror=()=>s(r.error)})}async getCacheStats(){const e=this.db.transaction(["embeddings"],"readonly").objectStore("embeddings");return new Promise((t,s)=>{const r=e.count();r.onsuccess=()=>{t({totalEntries:r.result,dbName:this.dbName})},r.onerror=()=>s(r.error)})}}Lt.allowLocalModels=!1;const Gt="nomic-ai/nomic-embed-text-v1.5";class rt{constructor({openaiKey:n}={}){this.openaiKey=n,this.cache=new Ut}async init(){await this.cache.init()}async clearCache(){await this.cache.clearCache()}async initLocalEmbedder(n){const e=await Ot("feature-extraction",Gt,{quantized:!0,progress_callback:t=>{const{progress:s,loaded:r,total:i}=t;if(s){const l=Math.round(i/1048576),h=Math.round(r/(1024*1024));n({progress:s,loadedMB:h,totalMB:l})}}});this.embedder=e}async embed(n){if(this.openaiKey)return console.log("Embedding using OpenAI"),await this.embedOpenAI(n);const{embedder:e,cache:t}=this,s=[];for(let r of n){const i=await t.getEmbeddings(r);if(i!=null){s.push(i);continue}const l=(await e(r,{pooling:"mean",normalize:!0})).data;s.push(l),t.storeEmbeddings(r,l)}return s}async embedOpenAI(n){const{openaiKey:e,cache:t}=this;let s=[],r={};for(let u=0;u<n.length;u++){const f=n[u],a=await t.getEmbeddings(f);if(a!=null){r[u]=a;continue}else s.push({index:u,text:f})}if(s.length==0){const u=[];for(let f=0;f<n.length;f++)u.push(r[f]);return u}const h=(await(await fetch("https://api.openai.com/v1/embeddings",{method:"POST",headers:{Authorization:"Bearer "+e,"Content-Type":"application/json"},body:JSON.stringify({input:s.map(u=>u.text),model:"text-embedding-3-large",encoding_format:"float"})})).json()).data.map(u=>u.embedding);for(let u=0;u<s.length;u++){const f=s[u].index,a=s[u].text,m=h[u];await t.storeEmbeddings(a,m),r[f]=m}const c=[];for(let u=0;u<n.length;u++)c.push(r[u]);return c}}function P(o,n){let e=0;for(let t=0;t<o.length;t++)e+=(o[t]-n[t])*(o[t]-n[t]);return e}const x={distanceFunction:P};function Ht(o,n,e=x){const t=e.distanceFunction||x.distanceFunction,s=e.similarityFunction||x.similarityFunction;let r=-1;if(typeof s=="function"){let i=Number.MIN_VALUE;for(let l=0;l<o.length;l++){const h=s(n,o[l]);h>i&&(i=h,r=l)}}else if(typeof t=="function"){let i=Number.MAX_VALUE;for(let l=0;l<o.length;l++){const h=t(n,o[l]);h<i&&(i=h,r=l)}}else throw new Error("A similarity or distance function it's required");return r}function Xt(o,n){let e=new Array(o.length);for(let t=0;t<o.length;++t)for(let s=t;s<o.length;++s){e[t]||(e[t]=new Array(o.length)),e[s]||(e[s]=new Array(o.length));const r=n(o[t],o[s]);e[t][s]=r,e[s][t]=r}return e}function mt(o,n,e,t){for(let s=0;s<o.length;s++)e[s]=Ht(n,o[s],{distanceFunction:t});return e}function Wt(o,n,e,t){const s=n[0].length;let r=new Array(t),i=new Array(t);for(let l=0;l<t;l++){r[l]=new Array(s),i[l]=0;for(let h=0;h<s;h++)r[l][h]=0}for(let l=0;l<n.length;l++){i[e[l]]++;for(let h=0;h<s;h++)r[e[l]][h]+=n[l][h]}for(let l=0;l<t;l++)for(let h=0;h<s;h++)i[l]?r[l][h]/=i[l]:r[l][h]=o[l][h];return r}function Yt(o,n,e,t){for(let s=0;s<o.length;s++)if(e(o[s],n[s])>t)return!1;return!0}class Jt{constructor(n,e,t,s,r){this.clusters=n,this.centroids=e,this.converged=t,this.iterations=s,this.distance=r}nearest(n){const e=new Array(n.length);return mt(n,this.centroids,e,this.distance)}computeInformation(n){let e=this.centroids.map(t=>({centroid:t,error:0,size:0}));for(let t=0;t<n.length;t++)e[this.clusters[t]].error+=this.distance(n[t],this.centroids[this.clusters[t]]),e[this.clusters[t]].size++;for(let t=0;t<this.centroids.length;t++){let s=e[t].error;e[t].size&&s!==-1?s/=e[t].size:e[t].error=-1}return e}}function _t(o,n){throw new Error(`${n}: "${String(o)}"`)}function Qt(o,n){if(n<=0||n>o.length||!Number.isInteger(n))throw new Error("K should be a positive integer smaller than the number of points")}const Zt=Object.prototype.toString;function q(o){const n=Zt.call(o);return n.endsWith("Array]")&&!n.includes("Big")}function Kt(o){var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!q(o))throw new TypeError("input must be an array");if(o.length===0)throw new TypeError("input must not be empty");var e=n.fromIndex,t=e===void 0?0:e,s=n.toIndex,r=s===void 0?o.length:s;if(t<0||t>=o.length||!Number.isInteger(t))throw new Error("fromIndex must be a positive integer smaller than length");if(r<=t||r>o.length||!Number.isInteger(r))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var i=o[t],l=t+1;l<r;l++)o[l]>i&&(i=o[l]);return i}function xt(o){var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!q(o))throw new TypeError("input must be an array");if(o.length===0)throw new TypeError("input must not be empty");var e=n.fromIndex,t=e===void 0?0:e,s=n.toIndex,r=s===void 0?o.length:s;if(t<0||t>=o.length||!Number.isInteger(t))throw new Error("fromIndex must be a positive integer smaller than length");if(r<=t||r>o.length||!Number.isInteger(r))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var i=o[t],l=t+1;l<r;l++)o[l]<i&&(i=o[l]);return i}function it(o){var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(q(o)){if(o.length===0)throw new TypeError("input must not be empty")}else throw new TypeError("input must be an array");var e;if(n.output!==void 0){if(!q(n.output))throw new TypeError("output option must be an array if specified");e=n.output}else e=new Array(o.length);var t=xt(o),s=Kt(o);if(t===s)throw new RangeError("minimum and maximum input values are equal. Cannot rescale a constant array");var r=n.min,i=r===void 0?n.autoMinMax?t:0:r,l=n.max,h=l===void 0?n.autoMinMax?s:1:l;if(i>=h)throw new RangeError("min option must be smaller than max option");for(var c=(h-i)/(s-t),u=0;u<o.length;u++)e[u]=(o[u]-t)*c+i;return e}const W=" ".repeat(2),gt=" ".repeat(4);function At(){return wt(this)}function wt(o,n={}){const{maxRows:e=15,maxColumns:t=10,maxNumSize:s=8,padMinus:r="auto"}=n;return`${o.constructor.name} {
${W}[
${gt}${te(o,e,t,s,r)}
${W}]
${W}rows: ${o.rows}
${W}columns: ${o.columns}
}`}function te(o,n,e,t,s){const{rows:r,columns:i}=o,l=Math.min(r,n),h=Math.min(i,e),c=[];if(s==="auto"){s=!1;t:for(let u=0;u<l;u++)for(let f=0;f<h;f++)if(o.get(u,f)<0){s=!0;break t}}for(let u=0;u<l;u++){let f=[];for(let a=0;a<h;a++)f.push(ee(o.get(u,a),t,s));c.push(`${f.join(" ")}`)}return h!==i&&(c[c.length-1]+=` ... ${i-e} more columns`),l!==r&&c.push(`... ${r-n} more rows`),c.join(`
${gt}`)}function ee(o,n,e){return(o>=0&&e?` ${lt(o,n-1)}`:lt(o,n)).padEnd(n)}function lt(o,n){let e=o.toString();if(e.length<=n)return e;let t=o.toFixed(n);if(t.length>n&&(t=o.toFixed(Math.max(0,n-(t.length-n)))),t.length<=n&&!t.startsWith("0.000")&&!t.startsWith("-0.000"))return t;let s=o.toExponential(n);return s.length>n&&(s=o.toExponential(Math.max(0,n-(s.length-n)))),s.slice(0)}function ne(o,n){o.prototype.add=function(t){return typeof t=="number"?this.addS(t):this.addM(t)},o.prototype.addS=function(t){for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)+t);return this},o.prototype.addM=function(t){if(t=n.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)+t.get(s,r));return this},o.add=function(t,s){return new n(t).add(s)},o.prototype.sub=function(t){return typeof t=="number"?this.subS(t):this.subM(t)},o.prototype.subS=function(t){for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)-t);return this},o.prototype.subM=function(t){if(t=n.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)-t.get(s,r));return this},o.sub=function(t,s){return new n(t).sub(s)},o.prototype.subtract=o.prototype.sub,o.prototype.subtractS=o.prototype.subS,o.prototype.subtractM=o.prototype.subM,o.subtract=o.sub,o.prototype.mul=function(t){return typeof t=="number"?this.mulS(t):this.mulM(t)},o.prototype.mulS=function(t){for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)*t);return this},o.prototype.mulM=function(t){if(t=n.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)*t.get(s,r));return this},o.mul=function(t,s){return new n(t).mul(s)},o.prototype.multiply=o.prototype.mul,o.prototype.multiplyS=o.prototype.mulS,o.prototype.multiplyM=o.prototype.mulM,o.multiply=o.mul,o.prototype.div=function(t){return typeof t=="number"?this.divS(t):this.divM(t)},o.prototype.divS=function(t){for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)/t);return this},o.prototype.divM=function(t){if(t=n.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)/t.get(s,r));return this},o.div=function(t,s){return new n(t).div(s)},o.prototype.divide=o.prototype.div,o.prototype.divideS=o.prototype.divS,o.prototype.divideM=o.prototype.divM,o.divide=o.div,o.prototype.mod=function(t){return typeof t=="number"?this.modS(t):this.modM(t)},o.prototype.modS=function(t){for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)%t);return this},o.prototype.modM=function(t){if(t=n.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)%t.get(s,r));return this},o.mod=function(t,s){return new n(t).mod(s)},o.prototype.modulus=o.prototype.mod,o.prototype.modulusS=o.prototype.modS,o.prototype.modulusM=o.prototype.modM,o.modulus=o.mod,o.prototype.and=function(t){return typeof t=="number"?this.andS(t):this.andM(t)},o.prototype.andS=function(t){for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)&t);return this},o.prototype.andM=function(t){if(t=n.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)&t.get(s,r));return this},o.and=function(t,s){return new n(t).and(s)},o.prototype.or=function(t){return typeof t=="number"?this.orS(t):this.orM(t)},o.prototype.orS=function(t){for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)|t);return this},o.prototype.orM=function(t){if(t=n.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)|t.get(s,r));return this},o.or=function(t,s){return new n(t).or(s)},o.prototype.xor=function(t){return typeof t=="number"?this.xorS(t):this.xorM(t)},o.prototype.xorS=function(t){for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)^t);return this},o.prototype.xorM=function(t){if(t=n.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)^t.get(s,r));return this},o.xor=function(t,s){return new n(t).xor(s)},o.prototype.leftShift=function(t){return typeof t=="number"?this.leftShiftS(t):this.leftShiftM(t)},o.prototype.leftShiftS=function(t){for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)<<t);return this},o.prototype.leftShiftM=function(t){if(t=n.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)<<t.get(s,r));return this},o.leftShift=function(t,s){return new n(t).leftShift(s)},o.prototype.signPropagatingRightShift=function(t){return typeof t=="number"?this.signPropagatingRightShiftS(t):this.signPropagatingRightShiftM(t)},o.prototype.signPropagatingRightShiftS=function(t){for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)>>t);return this},o.prototype.signPropagatingRightShiftM=function(t){if(t=n.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)>>t.get(s,r));return this},o.signPropagatingRightShift=function(t,s){return new n(t).signPropagatingRightShift(s)},o.prototype.rightShift=function(t){return typeof t=="number"?this.rightShiftS(t):this.rightShiftM(t)},o.prototype.rightShiftS=function(t){for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)>>>t);return this},o.prototype.rightShiftM=function(t){if(t=n.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)>>>t.get(s,r));return this},o.rightShift=function(t,s){return new n(t).rightShift(s)},o.prototype.zeroFillRightShift=o.prototype.rightShift,o.prototype.zeroFillRightShiftS=o.prototype.rightShiftS,o.prototype.zeroFillRightShiftM=o.prototype.rightShiftM,o.zeroFillRightShift=o.rightShift,o.prototype.not=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,~this.get(t,s));return this},o.not=function(t){return new n(t).not()},o.prototype.abs=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.abs(this.get(t,s)));return this},o.abs=function(t){return new n(t).abs()},o.prototype.acos=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.acos(this.get(t,s)));return this},o.acos=function(t){return new n(t).acos()},o.prototype.acosh=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.acosh(this.get(t,s)));return this},o.acosh=function(t){return new n(t).acosh()},o.prototype.asin=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.asin(this.get(t,s)));return this},o.asin=function(t){return new n(t).asin()},o.prototype.asinh=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.asinh(this.get(t,s)));return this},o.asinh=function(t){return new n(t).asinh()},o.prototype.atan=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.atan(this.get(t,s)));return this},o.atan=function(t){return new n(t).atan()},o.prototype.atanh=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.atanh(this.get(t,s)));return this},o.atanh=function(t){return new n(t).atanh()},o.prototype.cbrt=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.cbrt(this.get(t,s)));return this},o.cbrt=function(t){return new n(t).cbrt()},o.prototype.ceil=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.ceil(this.get(t,s)));return this},o.ceil=function(t){return new n(t).ceil()},o.prototype.clz32=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.clz32(this.get(t,s)));return this},o.clz32=function(t){return new n(t).clz32()},o.prototype.cos=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.cos(this.get(t,s)));return this},o.cos=function(t){return new n(t).cos()},o.prototype.cosh=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.cosh(this.get(t,s)));return this},o.cosh=function(t){return new n(t).cosh()},o.prototype.exp=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.exp(this.get(t,s)));return this},o.exp=function(t){return new n(t).exp()},o.prototype.expm1=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.expm1(this.get(t,s)));return this},o.expm1=function(t){return new n(t).expm1()},o.prototype.floor=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.floor(this.get(t,s)));return this},o.floor=function(t){return new n(t).floor()},o.prototype.fround=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.fround(this.get(t,s)));return this},o.fround=function(t){return new n(t).fround()},o.prototype.log=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.log(this.get(t,s)));return this},o.log=function(t){return new n(t).log()},o.prototype.log1p=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.log1p(this.get(t,s)));return this},o.log1p=function(t){return new n(t).log1p()},o.prototype.log10=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.log10(this.get(t,s)));return this},o.log10=function(t){return new n(t).log10()},o.prototype.log2=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.log2(this.get(t,s)));return this},o.log2=function(t){return new n(t).log2()},o.prototype.round=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.round(this.get(t,s)));return this},o.round=function(t){return new n(t).round()},o.prototype.sign=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.sign(this.get(t,s)));return this},o.sign=function(t){return new n(t).sign()},o.prototype.sin=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.sin(this.get(t,s)));return this},o.sin=function(t){return new n(t).sin()},o.prototype.sinh=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.sinh(this.get(t,s)));return this},o.sinh=function(t){return new n(t).sinh()},o.prototype.sqrt=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.sqrt(this.get(t,s)));return this},o.sqrt=function(t){return new n(t).sqrt()},o.prototype.tan=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.tan(this.get(t,s)));return this},o.tan=function(t){return new n(t).tan()},o.prototype.tanh=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.tanh(this.get(t,s)));return this},o.tanh=function(t){return new n(t).tanh()},o.prototype.trunc=function(){for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.set(t,s,Math.trunc(this.get(t,s)));return this},o.trunc=function(t){return new n(t).trunc()},o.pow=function(t,s){return new n(t).pow(s)},o.prototype.pow=function(t){return typeof t=="number"?this.powS(t):this.powM(t)},o.prototype.powS=function(t){for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)**t);return this},o.prototype.powM=function(t){if(t=n.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let s=0;s<this.rows;s++)for(let r=0;r<this.columns;r++)this.set(s,r,this.get(s,r)**t.get(s,r));return this}}function $(o,n,e){let t=e?o.rows:o.rows-1;if(n<0||n>t)throw new RangeError("Row index out of range")}function D(o,n,e){let t=e?o.columns:o.columns-1;if(n<0||n>t)throw new RangeError("Column index out of range")}function O(o,n){if(n.to1DArray&&(n=n.to1DArray()),n.length!==o.columns)throw new RangeError("vector size must be the same as the number of columns");return n}function U(o,n){if(n.to1DArray&&(n=n.to1DArray()),n.length!==o.rows)throw new RangeError("vector size must be the same as the number of rows");return n}function se(o,n){if(!q(n))throw new TypeError("row indices must be an array");for(let e=0;e<n.length;e++)if(n[e]<0||n[e]>=o.rows)throw new RangeError("row indices are out of range")}function oe(o,n){if(!q(n))throw new TypeError("column indices must be an array");for(let e=0;e<n.length;e++)if(n[e]<0||n[e]>=o.columns)throw new RangeError("column indices are out of range")}function ht(o,n,e,t,s){if(arguments.length!==5)throw new RangeError("expected 4 arguments");if(Y("startRow",n),Y("endRow",e),Y("startColumn",t),Y("endColumn",s),n>e||t>s||n<0||n>=o.rows||e<0||e>=o.rows||t<0||t>=o.columns||s<0||s>=o.columns)throw new RangeError("Submatrix indices are out of range")}function _(o,n=0){let e=[];for(let t=0;t<o;t++)e.push(n);return e}function Y(o,n){if(typeof n!="number")throw new TypeError(`${o} must be a number`)}function L(o){if(o.isEmpty())throw new Error("Empty matrix has no elements to index")}function re(o){let n=_(o.rows);for(let e=0;e<o.rows;++e)for(let t=0;t<o.columns;++t)n[e]+=o.get(e,t);return n}function ie(o){let n=_(o.columns);for(let e=0;e<o.rows;++e)for(let t=0;t<o.columns;++t)n[t]+=o.get(e,t);return n}function le(o){let n=0;for(let e=0;e<o.rows;e++)for(let t=0;t<o.columns;t++)n+=o.get(e,t);return n}function he(o){let n=_(o.rows,1);for(let e=0;e<o.rows;++e)for(let t=0;t<o.columns;++t)n[e]*=o.get(e,t);return n}function ue(o){let n=_(o.columns,1);for(let e=0;e<o.rows;++e)for(let t=0;t<o.columns;++t)n[t]*=o.get(e,t);return n}function ce(o){let n=1;for(let e=0;e<o.rows;e++)for(let t=0;t<o.columns;t++)n*=o.get(e,t);return n}function fe(o,n,e){const t=o.rows,s=o.columns,r=[];for(let i=0;i<t;i++){let l=0,h=0,c=0;for(let u=0;u<s;u++)c=o.get(i,u)-e[i],l+=c,h+=c*c;n?r.push((h-l*l/s)/(s-1)):r.push((h-l*l/s)/s)}return r}function ae(o,n,e){const t=o.rows,s=o.columns,r=[];for(let i=0;i<s;i++){let l=0,h=0,c=0;for(let u=0;u<t;u++)c=o.get(u,i)-e[i],l+=c,h+=c*c;n?r.push((h-l*l/t)/(t-1)):r.push((h-l*l/t)/t)}return r}function me(o,n,e){const t=o.rows,s=o.columns,r=t*s;let i=0,l=0,h=0;for(let c=0;c<t;c++)for(let u=0;u<s;u++)h=o.get(c,u)-e,i+=h,l+=h*h;return n?(l-i*i/r)/(r-1):(l-i*i/r)/r}function ge(o,n){for(let e=0;e<o.rows;e++)for(let t=0;t<o.columns;t++)o.set(e,t,o.get(e,t)-n[e])}function we(o,n){for(let e=0;e<o.rows;e++)for(let t=0;t<o.columns;t++)o.set(e,t,o.get(e,t)-n[t])}function de(o,n){for(let e=0;e<o.rows;e++)for(let t=0;t<o.columns;t++)o.set(e,t,o.get(e,t)-n)}function pe(o){const n=[];for(let e=0;e<o.rows;e++){let t=0;for(let s=0;s<o.columns;s++)t+=o.get(e,s)**2/(o.columns-1);n.push(Math.sqrt(t))}return n}function ye(o,n){for(let e=0;e<o.rows;e++)for(let t=0;t<o.columns;t++)o.set(e,t,o.get(e,t)/n[e])}function Se(o){const n=[];for(let e=0;e<o.columns;e++){let t=0;for(let s=0;s<o.rows;s++)t+=o.get(s,e)**2/(o.rows-1);n.push(Math.sqrt(t))}return n}function Ee(o,n){for(let e=0;e<o.rows;e++)for(let t=0;t<o.columns;t++)o.set(e,t,o.get(e,t)/n[t])}function be(o){const n=o.size-1;let e=0;for(let t=0;t<o.columns;t++)for(let s=0;s<o.rows;s++)e+=o.get(s,t)**2/n;return Math.sqrt(e)}function je(o,n){for(let e=0;e<o.rows;e++)for(let t=0;t<o.columns;t++)o.set(e,t,o.get(e,t)/n)}class p{static from1DArray(n,e,t){if(n*e!==t.length)throw new RangeError("data length does not match given dimensions");let r=new g(n,e);for(let i=0;i<n;i++)for(let l=0;l<e;l++)r.set(i,l,t[i*e+l]);return r}static rowVector(n){let e=new g(1,n.length);for(let t=0;t<n.length;t++)e.set(0,t,n[t]);return e}static columnVector(n){let e=new g(n.length,1);for(let t=0;t<n.length;t++)e.set(t,0,n[t]);return e}static zeros(n,e){return new g(n,e)}static ones(n,e){return new g(n,e).fill(1)}static rand(n,e,t={}){if(typeof t!="object")throw new TypeError("options must be an object");const{random:s=Math.random}=t;let r=new g(n,e);for(let i=0;i<n;i++)for(let l=0;l<e;l++)r.set(i,l,s());return r}static randInt(n,e,t={}){if(typeof t!="object")throw new TypeError("options must be an object");const{min:s=0,max:r=1e3,random:i=Math.random}=t;if(!Number.isInteger(s))throw new TypeError("min must be an integer");if(!Number.isInteger(r))throw new TypeError("max must be an integer");if(s>=r)throw new RangeError("min must be smaller than max");let l=r-s,h=new g(n,e);for(let c=0;c<n;c++)for(let u=0;u<e;u++){let f=s+Math.round(i()*l);h.set(c,u,f)}return h}static eye(n,e,t){e===void 0&&(e=n),t===void 0&&(t=1);let s=Math.min(n,e),r=this.zeros(n,e);for(let i=0;i<s;i++)r.set(i,i,t);return r}static diag(n,e,t){let s=n.length;e===void 0&&(e=s),t===void 0&&(t=e);let r=Math.min(s,e,t),i=this.zeros(e,t);for(let l=0;l<r;l++)i.set(l,l,n[l]);return i}static min(n,e){n=this.checkMatrix(n),e=this.checkMatrix(e);let t=n.rows,s=n.columns,r=new g(t,s);for(let i=0;i<t;i++)for(let l=0;l<s;l++)r.set(i,l,Math.min(n.get(i,l),e.get(i,l)));return r}static max(n,e){n=this.checkMatrix(n),e=this.checkMatrix(e);let t=n.rows,s=n.columns,r=new this(t,s);for(let i=0;i<t;i++)for(let l=0;l<s;l++)r.set(i,l,Math.max(n.get(i,l),e.get(i,l)));return r}static checkMatrix(n){return p.isMatrix(n)?n:new g(n)}static isMatrix(n){return n!=null&&n.klass==="Matrix"}get size(){return this.rows*this.columns}apply(n){if(typeof n!="function")throw new TypeError("callback must be a function");for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)n.call(this,e,t);return this}to1DArray(){let n=[];for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)n.push(this.get(e,t));return n}to2DArray(){let n=[];for(let e=0;e<this.rows;e++){n.push([]);for(let t=0;t<this.columns;t++)n[e].push(this.get(e,t))}return n}toJSON(){return this.to2DArray()}isRowVector(){return this.rows===1}isColumnVector(){return this.columns===1}isVector(){return this.rows===1||this.columns===1}isSquare(){return this.rows===this.columns}isEmpty(){return this.rows===0||this.columns===0}isSymmetric(){if(this.isSquare()){for(let n=0;n<this.rows;n++)for(let e=0;e<=n;e++)if(this.get(n,e)!==this.get(e,n))return!1;return!0}return!1}isDistance(){if(!this.isSymmetric())return!1;for(let n=0;n<this.rows;n++)if(this.get(n,n)!==0)return!1;return!0}isEchelonForm(){let n=0,e=0,t=-1,s=!0,r=!1;for(;n<this.rows&&s;){for(e=0,r=!1;e<this.columns&&r===!1;)this.get(n,e)===0?e++:this.get(n,e)===1&&e>t?(r=!0,t=e):(s=!1,r=!0);n++}return s}isReducedEchelonForm(){let n=0,e=0,t=-1,s=!0,r=!1;for(;n<this.rows&&s;){for(e=0,r=!1;e<this.columns&&r===!1;)this.get(n,e)===0?e++:this.get(n,e)===1&&e>t?(r=!0,t=e):(s=!1,r=!0);for(let i=e+1;i<this.rows;i++)this.get(n,i)!==0&&(s=!1);n++}return s}echelonForm(){let n=this.clone(),e=0,t=0;for(;e<n.rows&&t<n.columns;){let s=e;for(let r=e;r<n.rows;r++)n.get(r,t)>n.get(s,t)&&(s=r);if(n.get(s,t)===0)t++;else{n.swapRows(e,s);let r=n.get(e,t);for(let i=t;i<n.columns;i++)n.set(e,i,n.get(e,i)/r);for(let i=e+1;i<n.rows;i++){let l=n.get(i,t)/n.get(e,t);n.set(i,t,0);for(let h=t+1;h<n.columns;h++)n.set(i,h,n.get(i,h)-n.get(e,h)*l)}e++,t++}}return n}reducedEchelonForm(){let n=this.echelonForm(),e=n.columns,t=n.rows,s=t-1;for(;s>=0;)if(n.maxRow(s)===0)s--;else{let r=0,i=!1;for(;r<t&&i===!1;)n.get(s,r)===1?i=!0:r++;for(let l=0;l<s;l++){let h=n.get(l,r);for(let c=r;c<e;c++){let u=n.get(l,c)-h*n.get(s,c);n.set(l,c,u)}}s--}return n}set(){throw new Error("set method is unimplemented")}get(){throw new Error("get method is unimplemented")}repeat(n={}){if(typeof n!="object")throw new TypeError("options must be an object");const{rows:e=1,columns:t=1}=n;if(!Number.isInteger(e)||e<=0)throw new TypeError("rows must be a positive integer");if(!Number.isInteger(t)||t<=0)throw new TypeError("columns must be a positive integer");let s=new g(this.rows*e,this.columns*t);for(let r=0;r<e;r++)for(let i=0;i<t;i++)s.setSubMatrix(this,this.rows*r,this.columns*i);return s}fill(n){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,n);return this}neg(){return this.mulS(-1)}getRow(n){$(this,n);let e=[];for(let t=0;t<this.columns;t++)e.push(this.get(n,t));return e}getRowVector(n){return g.rowVector(this.getRow(n))}setRow(n,e){$(this,n),e=O(this,e);for(let t=0;t<this.columns;t++)this.set(n,t,e[t]);return this}swapRows(n,e){$(this,n),$(this,e);for(let t=0;t<this.columns;t++){let s=this.get(n,t);this.set(n,t,this.get(e,t)),this.set(e,t,s)}return this}getColumn(n){D(this,n);let e=[];for(let t=0;t<this.rows;t++)e.push(this.get(t,n));return e}getColumnVector(n){return g.columnVector(this.getColumn(n))}setColumn(n,e){D(this,n),e=U(this,e);for(let t=0;t<this.rows;t++)this.set(t,n,e[t]);return this}swapColumns(n,e){D(this,n),D(this,e);for(let t=0;t<this.rows;t++){let s=this.get(t,n);this.set(t,n,this.get(t,e)),this.set(t,e,s)}return this}addRowVector(n){n=O(this,n);for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,this.get(e,t)+n[t]);return this}subRowVector(n){n=O(this,n);for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,this.get(e,t)-n[t]);return this}mulRowVector(n){n=O(this,n);for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,this.get(e,t)*n[t]);return this}divRowVector(n){n=O(this,n);for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,this.get(e,t)/n[t]);return this}addColumnVector(n){n=U(this,n);for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,this.get(e,t)+n[e]);return this}subColumnVector(n){n=U(this,n);for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,this.get(e,t)-n[e]);return this}mulColumnVector(n){n=U(this,n);for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,this.get(e,t)*n[e]);return this}divColumnVector(n){n=U(this,n);for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)this.set(e,t,this.get(e,t)/n[e]);return this}mulRow(n,e){$(this,n);for(let t=0;t<this.columns;t++)this.set(n,t,this.get(n,t)*e);return this}mulColumn(n,e){D(this,n);for(let t=0;t<this.rows;t++)this.set(t,n,this.get(t,n)*e);return this}max(n){if(this.isEmpty())return NaN;switch(n){case"row":{const e=new Array(this.rows).fill(Number.NEGATIVE_INFINITY);for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.get(t,s)>e[t]&&(e[t]=this.get(t,s));return e}case"column":{const e=new Array(this.columns).fill(Number.NEGATIVE_INFINITY);for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.get(t,s)>e[s]&&(e[s]=this.get(t,s));return e}case void 0:{let e=this.get(0,0);for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.get(t,s)>e&&(e=this.get(t,s));return e}default:throw new Error(`invalid option: ${n}`)}}maxIndex(){L(this);let n=this.get(0,0),e=[0,0];for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.get(t,s)>n&&(n=this.get(t,s),e[0]=t,e[1]=s);return e}min(n){if(this.isEmpty())return NaN;switch(n){case"row":{const e=new Array(this.rows).fill(Number.POSITIVE_INFINITY);for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.get(t,s)<e[t]&&(e[t]=this.get(t,s));return e}case"column":{const e=new Array(this.columns).fill(Number.POSITIVE_INFINITY);for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.get(t,s)<e[s]&&(e[s]=this.get(t,s));return e}case void 0:{let e=this.get(0,0);for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.get(t,s)<e&&(e=this.get(t,s));return e}default:throw new Error(`invalid option: ${n}`)}}minIndex(){L(this);let n=this.get(0,0),e=[0,0];for(let t=0;t<this.rows;t++)for(let s=0;s<this.columns;s++)this.get(t,s)<n&&(n=this.get(t,s),e[0]=t,e[1]=s);return e}maxRow(n){if($(this,n),this.isEmpty())return NaN;let e=this.get(n,0);for(let t=1;t<this.columns;t++)this.get(n,t)>e&&(e=this.get(n,t));return e}maxRowIndex(n){$(this,n),L(this);let e=this.get(n,0),t=[n,0];for(let s=1;s<this.columns;s++)this.get(n,s)>e&&(e=this.get(n,s),t[1]=s);return t}minRow(n){if($(this,n),this.isEmpty())return NaN;let e=this.get(n,0);for(let t=1;t<this.columns;t++)this.get(n,t)<e&&(e=this.get(n,t));return e}minRowIndex(n){$(this,n),L(this);let e=this.get(n,0),t=[n,0];for(let s=1;s<this.columns;s++)this.get(n,s)<e&&(e=this.get(n,s),t[1]=s);return t}maxColumn(n){if(D(this,n),this.isEmpty())return NaN;let e=this.get(0,n);for(let t=1;t<this.rows;t++)this.get(t,n)>e&&(e=this.get(t,n));return e}maxColumnIndex(n){D(this,n),L(this);let e=this.get(0,n),t=[0,n];for(let s=1;s<this.rows;s++)this.get(s,n)>e&&(e=this.get(s,n),t[0]=s);return t}minColumn(n){if(D(this,n),this.isEmpty())return NaN;let e=this.get(0,n);for(let t=1;t<this.rows;t++)this.get(t,n)<e&&(e=this.get(t,n));return e}minColumnIndex(n){D(this,n),L(this);let e=this.get(0,n),t=[0,n];for(let s=1;s<this.rows;s++)this.get(s,n)<e&&(e=this.get(s,n),t[0]=s);return t}diag(){let n=Math.min(this.rows,this.columns),e=[];for(let t=0;t<n;t++)e.push(this.get(t,t));return e}norm(n="frobenius"){switch(n){case"max":return this.max();case"frobenius":return Math.sqrt(this.dot(this));default:throw new RangeError(`unknown norm type: ${n}`)}}cumulativeSum(){let n=0;for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)n+=this.get(e,t),this.set(e,t,n);return this}dot(n){p.isMatrix(n)&&(n=n.to1DArray());let e=this.to1DArray();if(e.length!==n.length)throw new RangeError("vectors do not have the same size");let t=0;for(let s=0;s<e.length;s++)t+=e[s]*n[s];return t}mmul(n){n=g.checkMatrix(n);let e=this.rows,t=this.columns,s=n.columns,r=new g(e,s),i=new Float64Array(t);for(let l=0;l<s;l++){for(let h=0;h<t;h++)i[h]=n.get(h,l);for(let h=0;h<e;h++){let c=0;for(let u=0;u<t;u++)c+=this.get(h,u)*i[u];r.set(h,l,c)}}return r}mpow(n){if(!this.isSquare())throw new RangeError("Matrix must be square");if(!Number.isInteger(n)||n<0)throw new RangeError("Exponent must be a non-negative integer");let e=g.eye(this.rows),t=this;for(let s=n;s>=1;s/=2)(s&1)!==0&&(e=e.mmul(t)),t=t.mmul(t);return e}strassen2x2(n){n=g.checkMatrix(n);let e=new g(2,2);const t=this.get(0,0),s=n.get(0,0),r=this.get(0,1),i=n.get(0,1),l=this.get(1,0),h=n.get(1,0),c=this.get(1,1),u=n.get(1,1),f=(t+c)*(s+u),a=(l+c)*s,m=t*(i-u),y=c*(h-s),d=(t+r)*u,w=(l-t)*(s+i),j=(r-c)*(h+u),S=f+y-d+j,k=m+d,E=a+y,v=f-a+m+w;return e.set(0,0,S),e.set(0,1,k),e.set(1,0,E),e.set(1,1,v),e}strassen3x3(n){n=g.checkMatrix(n);let e=new g(3,3);const t=this.get(0,0),s=this.get(0,1),r=this.get(0,2),i=this.get(1,0),l=this.get(1,1),h=this.get(1,2),c=this.get(2,0),u=this.get(2,1),f=this.get(2,2),a=n.get(0,0),m=n.get(0,1),y=n.get(0,2),d=n.get(1,0),w=n.get(1,1),j=n.get(1,2),S=n.get(2,0),k=n.get(2,1),E=n.get(2,2),v=(t+s+r-i-l-u-f)*w,M=(t-i)*(-m+w),b=l*(-a+m+d-w-j-S+E),I=(-t+i+l)*(a-m+w),N=(i+l)*(-a+m),C=t*a,F=(-t+c+u)*(a-y+j),z=(-t+c)*(y-j),G=(c+u)*(-a+y),Q=(t+s+r-l-h-c-u)*j,Z=u*(-a+y+d-w-j-S+k),T=(-r+u+f)*(w+S-k),X=(r-f)*(w-k),V=r*S,B=(u+f)*(-S+k),R=(-r+l+h)*(j+S-E),et=(r-h)*(j-E),nt=(l+h)*(-S+E),dt=s*d,pt=h*k,yt=i*y,St=c*m,Et=f*E,bt=C+V+dt,jt=v+I+N+C+T+V+B,It=C+F+G+Q+V+R+nt,kt=M+b+I+C+V+R+et,Nt=M+I+N+C+pt,vt=V+R+et+nt+yt,Mt=C+F+z+Z+T+X+V,Tt=T+X+V+B+St,Rt=C+F+z+G+Et;return e.set(0,0,bt),e.set(0,1,jt),e.set(0,2,It),e.set(1,0,kt),e.set(1,1,Nt),e.set(1,2,vt),e.set(2,0,Mt),e.set(2,1,Tt),e.set(2,2,Rt),e}mmulStrassen(n){n=g.checkMatrix(n);let e=this.clone(),t=e.rows,s=e.columns,r=n.rows,i=n.columns;s!==r&&console.warn(`Multiplying ${t} x ${s} and ${r} x ${i} matrix: dimensions do not match.`);function l(f,a,m){let y=f.rows,d=f.columns;if(y===a&&d===m)return f;{let w=p.zeros(a,m);return w=w.setSubMatrix(f,0,0),w}}let h=Math.max(t,r),c=Math.max(s,i);e=l(e,h,c),n=l(n,h,c);function u(f,a,m,y){if(m<=512||y<=512)return f.mmul(a);m%2===1&&y%2===1?(f=l(f,m+1,y+1),a=l(a,m+1,y+1)):m%2===1?(f=l(f,m+1,y),a=l(a,m+1,y)):y%2===1&&(f=l(f,m,y+1),a=l(a,m,y+1));let d=parseInt(f.rows/2,10),w=parseInt(f.columns/2,10),j=f.subMatrix(0,d-1,0,w-1),S=a.subMatrix(0,d-1,0,w-1),k=f.subMatrix(0,d-1,w,f.columns-1),E=a.subMatrix(0,d-1,w,a.columns-1),v=f.subMatrix(d,f.rows-1,0,w-1),M=a.subMatrix(d,a.rows-1,0,w-1),b=f.subMatrix(d,f.rows-1,w,f.columns-1),I=a.subMatrix(d,a.rows-1,w,a.columns-1),N=u(p.add(j,b),p.add(S,I),d,w),C=u(p.add(v,b),S,d,w),F=u(j,p.sub(E,I),d,w),z=u(b,p.sub(M,S),d,w),G=u(p.add(j,k),I,d,w),Q=u(p.sub(v,j),p.add(S,E),d,w),Z=u(p.sub(k,b),p.add(M,I),d,w),T=p.add(N,z);T.sub(G),T.add(Z);let X=p.add(F,G),V=p.add(C,z),B=p.sub(N,C);B.add(F),B.add(Q);let R=p.zeros(2*T.rows,2*T.columns);return R=R.setSubMatrix(T,0,0),R=R.setSubMatrix(X,T.rows,0),R=R.setSubMatrix(V,0,T.columns),R=R.setSubMatrix(B,T.rows,T.columns),R.subMatrix(0,m-1,0,y-1)}return u(e,n,h,c)}scaleRows(n={}){if(typeof n!="object")throw new TypeError("options must be an object");const{min:e=0,max:t=1}=n;if(!Number.isFinite(e))throw new TypeError("min must be a number");if(!Number.isFinite(t))throw new TypeError("max must be a number");if(e>=t)throw new RangeError("min must be smaller than max");let s=new g(this.rows,this.columns);for(let r=0;r<this.rows;r++){const i=this.getRow(r);i.length>0&&it(i,{min:e,max:t,output:i}),s.setRow(r,i)}return s}scaleColumns(n={}){if(typeof n!="object")throw new TypeError("options must be an object");const{min:e=0,max:t=1}=n;if(!Number.isFinite(e))throw new TypeError("min must be a number");if(!Number.isFinite(t))throw new TypeError("max must be a number");if(e>=t)throw new RangeError("min must be smaller than max");let s=new g(this.rows,this.columns);for(let r=0;r<this.columns;r++){const i=this.getColumn(r);i.length&&it(i,{min:e,max:t,output:i}),s.setColumn(r,i)}return s}flipRows(){const n=Math.ceil(this.columns/2);for(let e=0;e<this.rows;e++)for(let t=0;t<n;t++){let s=this.get(e,t),r=this.get(e,this.columns-1-t);this.set(e,t,r),this.set(e,this.columns-1-t,s)}return this}flipColumns(){const n=Math.ceil(this.rows/2);for(let e=0;e<this.columns;e++)for(let t=0;t<n;t++){let s=this.get(t,e),r=this.get(this.rows-1-t,e);this.set(t,e,r),this.set(this.rows-1-t,e,s)}return this}kroneckerProduct(n){n=g.checkMatrix(n);let e=this.rows,t=this.columns,s=n.rows,r=n.columns,i=new g(e*s,t*r);for(let l=0;l<e;l++)for(let h=0;h<t;h++)for(let c=0;c<s;c++)for(let u=0;u<r;u++)i.set(s*l+c,r*h+u,this.get(l,h)*n.get(c,u));return i}kroneckerSum(n){if(n=g.checkMatrix(n),!this.isSquare()||!n.isSquare())throw new Error("Kronecker Sum needs two Square Matrices");let e=this.rows,t=n.rows,s=this.kroneckerProduct(g.eye(t,t)),r=g.eye(e,e).kroneckerProduct(n);return s.add(r)}transpose(){let n=new g(this.columns,this.rows);for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)n.set(t,e,this.get(e,t));return n}sortRows(n=ut){for(let e=0;e<this.rows;e++)this.setRow(e,this.getRow(e).sort(n));return this}sortColumns(n=ut){for(let e=0;e<this.columns;e++)this.setColumn(e,this.getColumn(e).sort(n));return this}subMatrix(n,e,t,s){ht(this,n,e,t,s);let r=new g(e-n+1,s-t+1);for(let i=n;i<=e;i++)for(let l=t;l<=s;l++)r.set(i-n,l-t,this.get(i,l));return r}subMatrixRow(n,e,t){if(e===void 0&&(e=0),t===void 0&&(t=this.columns-1),e>t||e<0||e>=this.columns||t<0||t>=this.columns)throw new RangeError("Argument out of range");let s=new g(n.length,t-e+1);for(let r=0;r<n.length;r++)for(let i=e;i<=t;i++){if(n[r]<0||n[r]>=this.rows)throw new RangeError(`Row index out of range: ${n[r]}`);s.set(r,i-e,this.get(n[r],i))}return s}subMatrixColumn(n,e,t){if(e===void 0&&(e=0),t===void 0&&(t=this.rows-1),e>t||e<0||e>=this.rows||t<0||t>=this.rows)throw new RangeError("Argument out of range");let s=new g(t-e+1,n.length);for(let r=0;r<n.length;r++)for(let i=e;i<=t;i++){if(n[r]<0||n[r]>=this.columns)throw new RangeError(`Column index out of range: ${n[r]}`);s.set(i-e,r,this.get(i,n[r]))}return s}setSubMatrix(n,e,t){if(n=g.checkMatrix(n),n.isEmpty())return this;let s=e+n.rows-1,r=t+n.columns-1;ht(this,e,s,t,r);for(let i=0;i<n.rows;i++)for(let l=0;l<n.columns;l++)this.set(e+i,t+l,n.get(i,l));return this}selection(n,e){se(this,n),oe(this,e);let t=new g(n.length,e.length);for(let s=0;s<n.length;s++){let r=n[s];for(let i=0;i<e.length;i++){let l=e[i];t.set(s,i,this.get(r,l))}}return t}trace(){let n=Math.min(this.rows,this.columns),e=0;for(let t=0;t<n;t++)e+=this.get(t,t);return e}clone(){return this.constructor.copy(this,new g(this.rows,this.columns))}static copy(n,e){for(const[t,s,r]of n.entries())e.set(t,s,r);return e}sum(n){switch(n){case"row":return re(this);case"column":return ie(this);case void 0:return le(this);default:throw new Error(`invalid option: ${n}`)}}product(n){switch(n){case"row":return he(this);case"column":return ue(this);case void 0:return ce(this);default:throw new Error(`invalid option: ${n}`)}}mean(n){const e=this.sum(n);switch(n){case"row":{for(let t=0;t<this.rows;t++)e[t]/=this.columns;return e}case"column":{for(let t=0;t<this.columns;t++)e[t]/=this.rows;return e}case void 0:return e/this.size;default:throw new Error(`invalid option: ${n}`)}}variance(n,e={}){if(typeof n=="object"&&(e=n,n=void 0),typeof e!="object")throw new TypeError("options must be an object");const{unbiased:t=!0,mean:s=this.mean(n)}=e;if(typeof t!="boolean")throw new TypeError("unbiased must be a boolean");switch(n){case"row":{if(!q(s))throw new TypeError("mean must be an array");return fe(this,t,s)}case"column":{if(!q(s))throw new TypeError("mean must be an array");return ae(this,t,s)}case void 0:{if(typeof s!="number")throw new TypeError("mean must be a number");return me(this,t,s)}default:throw new Error(`invalid option: ${n}`)}}standardDeviation(n,e){typeof n=="object"&&(e=n,n=void 0);const t=this.variance(n,e);if(n===void 0)return Math.sqrt(t);for(let s=0;s<t.length;s++)t[s]=Math.sqrt(t[s]);return t}center(n,e={}){if(typeof n=="object"&&(e=n,n=void 0),typeof e!="object")throw new TypeError("options must be an object");const{center:t=this.mean(n)}=e;switch(n){case"row":{if(!q(t))throw new TypeError("center must be an array");return ge(this,t),this}case"column":{if(!q(t))throw new TypeError("center must be an array");return we(this,t),this}case void 0:{if(typeof t!="number")throw new TypeError("center must be a number");return de(this,t),this}default:throw new Error(`invalid option: ${n}`)}}scale(n,e={}){if(typeof n=="object"&&(e=n,n=void 0),typeof e!="object")throw new TypeError("options must be an object");let t=e.scale;switch(n){case"row":{if(t===void 0)t=pe(this);else if(!q(t))throw new TypeError("scale must be an array");return ye(this,t),this}case"column":{if(t===void 0)t=Se(this);else if(!q(t))throw new TypeError("scale must be an array");return Ee(this,t),this}case void 0:{if(t===void 0)t=be(this);else if(typeof t!="number")throw new TypeError("scale must be a number");return je(this,t),this}default:throw new Error(`invalid option: ${n}`)}}toString(n){return wt(this,n)}[Symbol.iterator](){return this.entries()}*entries(){for(let n=0;n<this.rows;n++)for(let e=0;e<this.columns;e++)yield[n,e,this.get(n,e)]}*values(){for(let n=0;n<this.rows;n++)for(let e=0;e<this.columns;e++)yield this.get(n,e)}}p.prototype.klass="Matrix";typeof Symbol!="undefined"&&(p.prototype[Symbol.for("nodejs.util.inspect.custom")]=At);function ut(o,n){return o-n}function Ie(o){return o.every(n=>typeof n=="number")}p.random=p.rand;p.randomInt=p.randInt;p.diagonal=p.diag;p.prototype.diagonal=p.prototype.diag;p.identity=p.eye;p.prototype.negate=p.prototype.neg;p.prototype.tensorProduct=p.prototype.kroneckerProduct;var H,A;const J=class extends p{constructor(e,t){super();ot(this,H);st(this,"data");if(J.isMatrix(e))K(this,H,A).call(this,e.rows,e.columns),J.copy(e,this);else if(Number.isInteger(e)&&e>=0)K(this,H,A).call(this,e,t);else if(q(e)){const s=e;if(e=s.length,t=e?s[0].length:0,typeof t!="number")throw new TypeError("Data must be a 2D array with at least one element");this.data=[];for(let r=0;r<e;r++){if(s[r].length!==t)throw new RangeError("Inconsistent array dimensions");if(!Ie(s[r]))throw new TypeError("Input data contains non-numeric values");this.data.push(Float64Array.from(s[r]))}this.rows=e,this.columns=t}else throw new TypeError("First argument must be a positive number or an array")}set(e,t,s){return this.data[e][t]=s,this}get(e,t){return this.data[e][t]}removeRow(e){return $(this,e),this.data.splice(e,1),this.rows-=1,this}addRow(e,t){return t===void 0&&(t=e,e=this.rows),$(this,e,!0),t=Float64Array.from(O(this,t)),this.data.splice(e,0,t),this.rows+=1,this}removeColumn(e){D(this,e);for(let t=0;t<this.rows;t++){const s=new Float64Array(this.columns-1);for(let r=0;r<e;r++)s[r]=this.data[t][r];for(let r=e+1;r<this.columns;r++)s[r-1]=this.data[t][r];this.data[t]=s}return this.columns-=1,this}addColumn(e,t){typeof t=="undefined"&&(t=e,e=this.columns),D(this,e,!0),t=U(this,t);for(let s=0;s<this.rows;s++){const r=new Float64Array(this.columns+1);let i=0;for(;i<e;i++)r[i]=this.data[s][i];for(r[i++]=t[s];i<this.columns+1;i++)r[i]=this.data[s][i-1];this.data[s]=r}return this.columns+=1,this}};let g=J;H=new WeakSet,A=function(e,t){if(this.data=[],Number.isInteger(t)&&t>=0)for(let s=0;s<e;s++)this.data.push(new Float64Array(t));else throw new TypeError("nColumns must be a positive integer");this.rows=e,this.columns=t};ne(p,g);const ct=8,ke=1/16777216,Ne=15,ve=18,Me=11;function Te(o,n){o>>>=0,n>>>=0;const e=o&65535;return((o-e)*n>>>0)+e*n>>>0}class Re{constructor(n=Date.now()){this.state=new Uint32Array(4),this.init(n),this.random=this.getFloat.bind(this)}getUint32(){return this.nextState(),this.state[3]+this.state[2]>>>0}getFloat(){return(this.getUint32()>>>8)*ke}init(n){if(!Number.isInteger(n))throw new TypeError("seed must be an integer");this.state[0]=n,this.state[1]=0,this.state[2]=0,this.state[3]=0;for(let e=1;e<ct;e++)this.state[e&3]^=e+Te(1812433253,this.state[e-1&3]^this.state[e-1&3]>>>30>>>0)>>>0;this.periodCertification();for(let e=0;e<ct;e++)this.nextState()}periodCertification(){this.state[0]===0&&this.state[1]===0&&this.state[2]===0&&this.state[3]===0&&(this.state[0]=88,this.state[1]=83,this.state[2]=65,this.state[3]=68)}nextState(){let n=this.state[0];n^=n<<Ne,n^=n>>>ve,n^=this.state[3]<<Me,this.state[0]=this.state[1],this.state[1]=this.state[2],this.state[2]=this.state[3],this.state[3]=n}}const qe=1e-8;function ft(o,n={},e=Math.random){const{size:t=1,replace:s=!1,probabilities:r}=n;let i,l;if(typeof o=="number"?i=Ce(o):i=o.slice(),r){if(!s)throw new Error("choice with probabilities and no replacement is not implemented");if(r.length!==i.length)throw new Error("the length of probabilities option should be equal to the number of choices");l=[r[0]];for(let c=1;c<r.length;c++)l[c]=l[c-1]+r[c];if(Math.abs(1-l[l.length-1])>qe)throw new Error(`probabilities should sum to 1, but instead sums to ${l[l.length-1]}`)}if(s===!1&&t>i.length)throw new Error("size option is too large");const h=[];for(let c=0;c<t;c++){const u=$e(i.length,e,l);h.push(i[u]),s||i.splice(u,1)}return h}function Ce(o){const n=[];for(let e=0;e<o;e++)n.push(e);return n}function $e(o,n,e){const t=n();if(e){let s=0;for(;t>e[s];)s++;return s}else return Math.floor(t*o)}class tt{constructor(n=Math.random){if(typeof n=="number"){const e=new Re(n);this.randomGenerator=e.random}else this.randomGenerator=n}choice(n,e){return typeof n=="number"?ft(n,e,this.randomGenerator):ft(n,e,this.randomGenerator)}random(){return this.randomGenerator()}randInt(n,e){return e===void 0&&(e=n,n=0),n+Math.floor(this.randomGenerator()*(e-n))}randomSample(n){const e=[];for(let t=0;t<n;t++)e.push(this.random());return e}}function De(o,n,e){return new tt(e).choice(o,{size:n})}function Fe(o,n,e,t){const s=new tt(t);let r=new Array(n);if(r[0]=Math.floor(s.random()*o.length),n>1){let i={dist:-1,index:-1};for(let l=0;l<o.length;++l)e[r[0]][l]>i.dist&&(i.dist=e[r[0]][l],i.index=l);if(r[1]=i.index,n>2)for(let l=2;l<n;++l){let h={dist:-1,index:-1};for(let c=0;c<o.length;++c){let u={dist:Number.MAX_VALUE,index:-1};for(let f=0;f<l;++f)e[f][c]<u.dist&&!r.includes(c)&&(u={dist:e[f][c],index:c});u.dist!==Number.MAX_VALUE&&u.dist>h.dist&&(h={...u})}r[l]=h.index}}return r.map(i=>o[i])}function ze(o,n,e={}){const t=new g(o),s=t.rows,r=new tt(e.seed),i=[],l=e.localTrials||2+Math.floor(Math.log(n)),h=r.randInt(s);i.push(t.getRow(h));let c=new g(1,t.rows);for(let m=0;m<t.rows;m++)c.set(0,m,P(t.getRow(m),i[0]));let u=[at(c.getRow(0))];const f=1/u[0][s-1];let a=g.mul(c,f);for(let m=1;m<n;m++){const y=r.choice(s,{replace:!0,size:l,probabilities:a.getRow(0)}),d=t.selection(y,Pe(t.columns)),w=Ve(d,t);let j=1/0,S=1/0,k=c;for(let E=0;E<l;E++){const v=g.min(c,[w.getRow(E)]),M=v.sum();M<S&&(j=y[E],S=M,k=v)}i[m]=t.getRow(j),c=k,u=[at(c.getRow(0))],a=g.mul(c,1/u[0][s-1])}return i}function Ve(o,n){const e=new g(o.rows,n.rows);for(let t=0;t<o.rows;t++)for(let s=0;s<n.rows;s++)e.set(t,s,P(o.getRow(t),n.getRow(s)));return e}function Pe(o){let n=[];for(let e=0;e<o;e++)n.push(e);return n}function at(o){let n=[o[0]];for(let e=1;e<o.length;e++)n[e]=n[e-1]+o[e];return n}const Be={maxIterations:100,tolerance:1e-6,initialization:"kmeans++",distanceFunction:P};function Le(o,n,e,t,s,r){e=mt(n,o,e,s.distanceFunction);let i=Wt(o,n,e,t),l=Yt(i,o,s.distanceFunction,s.tolerance);return new Jt(e,i,l,r,s.distanceFunction)}function Oe(o,n,e){const t=Ge(e);Qt(o,n);let s=Ue(o,n,t);t.maxIterations===0&&(t.maxIterations=Number.MAX_VALUE);let r=new Array(o.length),i=!1,l=0,h;for(;!i&&l<t.maxIterations;)h=Le(s,o,r,n,t,++l),i=h.converged,s=h.centroids;if(!h)throw new Error("unreachable: no kmeans step executed");return h}function Ue(o,n,e){let t;if(Array.isArray(e.initialization)){if(e.initialization.length!==n)throw new Error("The initial centers should have the same length as K");t=e.initialization}else switch(e.initialization){case"kmeans++":t=ze(o,n,e);break;case"random":t=De(o,n,e.seed);break;case"mostDistant":t=Fe(o,n,Xt(o,e.distanceFunction),e.seed);break;default:_t(e.initialization,"Unknown initialization method")}return t}function Ge(o){return{...Be,...o}}function He(o,n=5,e=null){const t=o.map(l=>l.embedding);let s={};e&&(s={initialization:e});const r=Oe(t,n,s);return Xe(r,o)}function Xe(o,n){const{clusters:e,centroids:t}=o,s={};for(let i=0;i<e.length;i++){const l=e[i],h=n[i];s[l]==null&&(s[l]={items:[]}),s[l].items.push(h)}const r=Object.keys(s).map(i=>Number(i));for(let i=0;i<r.length;i++){const l=s[i].items,h=t[i],c=l.map(a=>P(a.embedding,h)),u=c.reduce((a,m)=>a+m,0)/c.length,f=c.reduce((a,m)=>a+Math.pow(m-u,2),0)/c.length;s[i].stdDev=Math.sqrt(f),l.sort((a,m)=>{const y=P(a.embedding,h),d=P(m.embedding,h);return y-d})}return Object.values(s)}let We=[],Ye=[];window.changeColumn=function(o){if(!o)return;const n=new URL(window.location.href);n.searchParams.set("column",o),window.location.href=n.toString()};document.addEventListener("DOMContentLoaded",function(){const o=document.querySelector("#openai-key");o.onblur=()=>{localStorage.setItem("openai-key",o.value)},localStorage.getItem("openai-key")&&(o.value=localStorage.getItem("openai-key"));const n=document.querySelector("#cluster-centers");n.onblur=()=>{localStorage.setItem("cluster-centers",n.value)},localStorage.getItem("cluster-centers")&&(n.value=localStorage.getItem("cluster-centers")),localStorage.getItem("num-clusters")&&(document.querySelector("#num-clusters").value=localStorage.getItem("num-clusters")),document.querySelector("#num-clusters").onblur=()=>{localStorage.setItem("num-clusters",document.querySelector("#num-clusters").value)};const e=new URLSearchParams(window.location.search),t=e.get("id"),s=e.get("column"),r=document.getElementById("info-banner"),i=document.getElementById("sheet-info");if(!t){u("No spreadsheet ID provided. Please go back and enter a valid Google Sheets URL.");return}i.textContent=`Spreadsheet ID: ${t.substring(0,8)}...`,l(t,s);async function l(f,a){try{const m=await Dt(f),y=await Ft(f);document.querySelector("#title").innerText=y,document.querySelector("#src-google-sheet").innerHTML=`
                    Source google sheet: 
                    <a target="_blank" href="https://docs.google.com/spreadsheets/d/${f}">https://docs.google.com/spreadsheets/d/${f}</a>
                    `;const w=(await zt(f))[0],j=m.values;if(!j||j.length<2)throw new Error("Not enough data in the spreadsheet or the spreadsheet is empty.");const S=j[0];We=S;const k=Vt(j);Ye=k;let E=null;if(a){if(E=Pt(S,a),!E)throw new Error(`Column "${a}" not found in the spreadsheet.`)}else E=S.find(M=>k.slice(0,5).map(N=>N[M]).some(N=>N&&N.length>20)),E||(E=S[0]);const v=Bt(k,E);document.getElementById("loading").style.display="none",r.innerHTML=`
                        <strong>Sheet:</strong> ${w} &nbsp; | &nbsp;
                        <strong>Column:</strong> ${E} &nbsp; | &nbsp;
                        <strong>Total Responses:</strong> ${v.length} &nbsp; | &nbsp;
                        <span id="num-clusters"></span>
                    `,h(S,E),document.querySelector("#run-button").style.display="inline-block",document.querySelector("#run-button").onclick=async()=>{await c(v)},document.querySelector("#clear-button").onclick=async()=>{const M=new rt;await M.init(),await M.clearCache(),alert("Done")}}catch(m){console.error("Error loading sheet data:",m),u(m.message||"Failed to load spreadsheet data")}}function h(f,a){const m=document.getElementById("column-select"),y=document.getElementById("column-selector-container");m.innerHTML="",f.forEach(d=>{const w=document.createElement("option");w.value=d,w.textContent=d,w.selected=d===a,m.appendChild(w)}),y.style.display="flex"}async function c(f){const a=document.querySelector("#response-list-container");a.innerHTML="";const m=document.querySelector("#num-clusters"),y=f.map(b=>b.text);console.log("LOADING SEMANTIC EMBEDDING");const d=new rt({openaiKey:localStorage.getItem("openai-key")});await d.init(),await d.initLocalEmbedder(console.log),window.clearCache=async()=>{await d.clearCache()},console.log("EMBEDDING TEXT");let w=[];const j=10;for(let b=0;b<y.length;b+=j){console.log(`Embedding ${b} / ${y.length}`);const I=y.slice(b,b+j),N=await d.embed(I);w.push(...N)}const S=[];for(let b=0;b<y.length;b++){const I=y[b],N=w[b];S.push({content:I,embedding:N})}console.log("Clustering");let k=Math.round(S.length/20);m.value!=""&&(k=Number(m.value));let E=null;if(localStorage.getItem("cluster-centers")){const b=localStorage.getItem("cluster-centers").split(`
`).filter(I=>I.length);E=await d.embed(b)}console.log({items:S,numClusters:k,centers:E});let v=He(S,k,E);v.sort((b,I)=>b.items.length-I.items.length),r.querySelector("#num-clusters").innerHTML=`<strong>Number of clusters:</strong> ${v.length}`;let M=1;for(let b of v){const I=document.createElement("div");I.id="response-list",I.className="response-list",a.appendChild(I);const N=document.createElement("h1");N.style="flex-basis: 100%;",N.textContent=`Cluster ${M} - (${b.items.length} responses)`,M++,I.appendChild(N);for(let C of b.items){const F=document.createElement("div");F.className="response-item";const z=document.createElement("div");z.className="response-content",z.textContent=C.content,F.appendChild(z),I.appendChild(F)}}}function u(f){document.getElementById("loading").style.display="none";const a=document.getElementById("error-container"),m=document.getElementById("error-message");m.textContent=f,a.style.display="block"}});
